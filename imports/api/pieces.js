import { Meteor } from "meteor/meteor";
import { Mongo } from "meteor/mongo";
import { check } from "meteor/check";

export const Pieces = new Mongo.Collection("pieces");

if (Meteor.isServer) {
  if (Pieces.find({}) == undefined || Pieces.find({}).count() == 0) {
    Pieces.insert({
      name: "Heart",
      owner: "David",
      createdAt: new Date(),
      private: false,
      size: 20,
      board: [
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 8, 8, 8, 0, 0, 0, 0, 8, 8, 8, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 8, 3, 3, 3, 8, 0, 0, 8, 5, 5, 6, 8, 0, 0, 0, 0],
        [0, 0, 0, 8, 3, 3, 3, 2, 2, 8, 8, 5, 5, 6, 6, 6, 8, 0, 0, 0],
        [0, 0, 8, 3, 3, 3, 1, 2, 2, 5, 5, 5, 6, 6, 6, 7, 7, 8, 0, 0],
        [0, 0, 8, 3, 3, 1, 1, 1, 5, 5, 5, 6, 6, 6, 7, 7, 7, 8, 0, 0],
        [0, 0, 8, 3, 2, 2, 1, 5, 5, 5, 6, 6, 6, 7, 7, 7, 4, 8, 0, 0],
        [0, 0, 8, 2, 2, 2, 5, 5, 5, 6, 6, 6, 7, 7, 7, 4, 4, 8, 0, 0],
        [0, 0, 0, 8, 2, 5, 5, 5, 6, 6, 6, 7, 7, 7, 4, 4, 8, 0, 0, 0],
        [0, 0, 0, 8, 5, 5, 5, 6, 6, 6, 7, 7, 7, 4, 4, 4, 8, 0, 0, 0],
        [0, 0, 0, 0, 8, 5, 6, 6, 6, 7, 7, 7, 4, 4, 4, 8, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 8, 6, 6, 7, 7, 7, 4, 4, 4, 8, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 8, 7, 7, 7, 4, 4, 4, 8, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 8, 7, 4, 4, 4, 8, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 8, 4, 4, 8, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 8, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
      ],
      colors: [
        "#FFFFFF",
        "#F3D1D1",
        "#951CD2",
        "#EB0B80",
        "#F36105",
        "#6CB6EF",
        "#58ED4E",
        "#F2F533",
        "#000000"
      ],
      cells: [{}, {}, {}, {}, {}, {}, {}, {}],
      editor: "David",
      modifiedAt: new Date(),
      fills: 0
    });
    Pieces.insert({
      name: "Smile",
      owner: "David",
      createdAt: new Date(),
      private: false,
      size: 30,
      board: [
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 3, 3, 3, 3, 3, 3, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 3, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 3, 3, 3, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 3, 3, 4, 4, 4, 4, 2, 2, 2, 2, 2, 2, 4, 4, 4, 4, 3, 3, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 3, 4, 4, 4, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 4, 4, 4, 3, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 3, 4, 4, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 4, 4, 3, 0, 0, 0, 0],
        [0, 0, 0, 3, 4, 4, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 4, 4, 3, 0, 0, 0],
        [0, 0, 3, 4, 4, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 4, 4, 3, 0, 0],
        [0, 0, 3, 4, 4, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 4, 4, 3, 0, 0],
        [0, 3, 4, 4, 4, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 4, 4, 4, 3, 0],
        [0, 3, 4, 4, 4, 4, 2, 2, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 1, 1, 1, 1, 2, 2, 4, 4, 4, 4, 3, 0],
        [0, 3, 4, 4, 4, 4, 4, 2, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 1, 1, 1, 1, 2, 4, 4, 4, 4, 4, 3, 0],
        [3, 4, 4, 4, 4, 4, 4, 4, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 1, 1, 1, 1, 4, 4, 4, 4, 4, 4, 4, 3],
        [3, 4, 4, 4, 4, 4, 4, 4, 1, 1, 1, 1, 4, 4, 4, 4, 4, 4, 1, 1, 1, 1, 4, 4, 4, 4, 4, 4, 4, 3],
        [3, 4, 4, 4, 4, 4, 4, 4, 4, 1, 1, 4, 4, 4, 4, 4, 4, 4, 4, 1, 1, 4, 4, 4, 4, 4, 4, 4, 4, 3],
        [3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 3],
        [3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 3, 3],
        [1, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 3, 1],
        [1, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 3, 1],
        [1, 3, 3, 4, 4, 4, 4, 4, 4, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 3, 4, 4, 4, 4, 4, 4, 3, 3, 1],
        [0, 1, 3, 4, 4, 4, 4, 4, 3, 1, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 1, 3, 4, 4, 4, 4, 4, 3, 1, 0],
        [0, 1, 3, 3, 4, 4, 4, 4, 4, 4, 1, 1, 4, 4, 4, 4, 4, 4, 1, 1, 4, 4, 4, 4, 4, 4, 3, 3, 1, 0],
        [0, 1, 3, 3, 3, 4, 4, 4, 4, 4, 4, 4, 1, 1, 1, 1, 1, 1, 4, 4, 4, 4, 4, 4, 4, 3, 3, 3, 1, 0],
        [0, 0, 1, 3, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 3, 3, 3, 1, 0, 0],
        [0, 0, 1, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 3, 3, 3, 3, 1, 0, 0],
        [0, 0, 0, 1, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 3, 3, 3, 3, 3, 1, 0, 0, 0],
        [0, 0, 0, 0, 1, 3, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 3, 3, 3, 3, 3, 3, 3, 1, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 1, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 1, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 1, 1, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 1, 1, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 3, 3, 3, 3, 3, 3, 3, 3, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
      ],
      colors: [
        "#FFFFFF",
        "#B32F02",
        "#FFFF00",
        "#ED8C04",
        "#EFB505"
      ],
      cells: [{}, {}, {}, {}, {}],
      editor: "David",
      modifiedAt: new Date(),
      fills: 0
    });
    Pieces.insert({
      name: "Pikachu",
      owner: "David",
      createdAt: new Date(),
      private: false,
      size: 40,
      board: [
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 6, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 6, 6, 6, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 6, 6, 6, 6, 6, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 2, 2, 2, 6, 6, 6, 0, 0],
        [0, 0, 0, 6, 6, 6, 6, 6, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 2, 2, 2, 2, 6, 6, 0, 0, 0],
        [0, 0, 0, 6, 6, 6, 3, 3, 3, 6, 6, 6, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 2, 2, 2, 2, 3, 6, 6, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 6, 6, 5, 2, 2, 2, 2, 3, 6, 6, 6, 6, 0, 6, 6, 6, 6, 6, 6, 6, 0, 6, 6, 2, 2, 2, 2, 3, 3, 6, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 6, 6, 5, 3, 2, 2, 2, 2, 2, 2, 3, 6, 2, 2, 2, 2, 2, 2, 2, 6, 3, 2, 2, 2, 2, 3, 3, 6, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 6, 6, 3, 3, 3, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 6, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 6, 3, 3, 3, 3, 3, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 6, 3, 6, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 6, 3, 6, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 6, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 6, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 6, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 2, 2, 2, 6, 6, 2, 2, 2, 2, 2, 2, 2, 2, 6, 6, 2, 2, 6, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 6, 3, 6, 0, 0, 0, 0, 0, 0, 0, 0, 6, 3, 2, 2, 6, 6, 1, 6, 2, 2, 2, 2, 2, 2, 6, 6, 1, 6, 2, 3, 6, 0, 0, 0, 0, 0, 0, 0],
        [0, 6, 2, 3, 6, 0, 0, 0, 0, 0, 0, 0, 6, 2, 2, 2, 6, 6, 6, 6, 2, 2, 2, 2, 2, 2, 6, 6, 6, 6, 2, 2, 6, 0, 0, 0, 0, 0, 0, 0],
        [0, 6, 2, 2, 3, 6, 0, 0, 0, 0, 0, 0, 6, 2, 2, 2, 2, 6, 6, 2, 2, 2, 2, 2, 2, 2, 2, 6, 6, 2, 2, 2, 6, 0, 0, 0, 0, 0, 0, 0],
        [0, 6, 2, 2, 2, 3, 6, 0, 0, 0, 0, 6, 2, 2, 4, 4, 2, 2, 2, 2, 2, 2, 6, 6, 2, 2, 2, 2, 2, 2, 4, 4, 2, 6, 0, 0, 0, 0, 0, 0],
        [0, 6, 2, 2, 2, 2, 3, 6, 0, 0, 0, 6, 2, 4, 4, 4, 4, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 4, 4, 4, 4, 6, 0, 0, 0, 0, 0, 0],
        [0, 6, 2, 2, 2, 2, 2, 3, 6, 0, 0, 6, 2, 4, 4, 4, 4, 2, 2, 6, 2, 2, 6, 6, 2, 2, 6, 2, 2, 4, 4, 4, 4, 6, 0, 0, 0, 0, 0, 0],
        [0, 6, 2, 2, 2, 2, 2, 2, 3, 6, 0, 6, 2, 2, 4, 4, 2, 2, 2, 2, 6, 6, 2, 2, 6, 6, 2, 2, 2, 2, 4, 4, 2, 6, 0, 0, 0, 0, 0, 0],
        [0, 6, 2, 2, 2, 2, 2, 2, 2, 3, 6, 6, 6, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 6, 0, 0, 0, 0, 0, 0, 0],
        [0, 6, 2, 2, 2, 2, 2, 2, 2, 2, 3, 6, 6, 3, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 6, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 6, 2, 2, 2, 2, 2, 2, 2, 2, 6, 0, 6, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 6, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 6, 2, 2, 2, 2, 2, 2, 6, 0, 6, 3, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 2, 2, 2, 2, 2, 2, 3, 6, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 6, 2, 2, 2, 2, 6, 0, 0, 6, 6, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 2, 2, 2, 2, 2, 2, 2, 2, 6, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 6, 2, 2, 2, 2, 6, 0, 0, 0, 6, 2, 2, 2, 2, 2, 2, 6, 2, 2, 2, 2, 2, 2, 6, 2, 2, 2, 2, 2, 6, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 6, 2, 2, 2, 2, 2, 6, 0, 6, 2, 2, 2, 6, 2, 2, 2, 6, 2, 2, 2, 2, 2, 2, 6, 2, 2, 2, 6, 2, 6, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 6, 2, 2, 2, 2, 2, 6, 6, 2, 2, 2, 6, 2, 2, 2, 2, 6, 2, 2, 2, 2, 6, 2, 2, 2, 2, 6, 2, 2, 6, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 6, 2, 2, 3, 3, 5, 6, 2, 2, 2, 3, 6, 2, 2, 2, 6, 2, 2, 2, 2, 6, 2, 2, 2, 6, 3, 2, 2, 6, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 6, 3, 3, 3, 6, 6, 2, 2, 2, 3, 6, 2, 2, 2, 6, 2, 2, 2, 2, 6, 2, 2, 2, 6, 3, 2, 2, 6, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 6, 3, 5, 5, 6, 2, 2, 2, 2, 3, 6, 2, 2, 6, 2, 2, 2, 2, 6, 2, 2, 6, 3, 2, 2, 2, 6, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 6, 5, 5, 5, 5, 6, 2, 2, 2, 2, 2, 3, 6, 6, 2, 2, 2, 2, 2, 2, 6, 6, 3, 2, 2, 2, 2, 6, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 6, 5, 5, 5, 6, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 6, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 6, 6, 5, 6, 3, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 6, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 6, 6, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 6, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 3, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 6, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 2, 2, 2, 2, 2, 2, 6, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 3, 2, 3, 3, 6, 6, 6, 6, 6, 6, 6, 3, 3, 2, 3, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 2, 2, 2, 6, 6, 6, 0, 0, 0, 0, 0, 0, 6, 6, 2, 2, 2, 6, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 6, 6, 6, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 6, 6, 6, 6, 0, 0, 0, 0, 0, 0, 0, 0]
      ],
      colors: [
        "#FFFFFF",
        "#FFFFFF",
        "#FFED00",
        "#FFB700",
        "#FF0000",
        "#A7772A",
        "#000000"
      ],
      cells: [{}, {}, {}, {}, {}, {}, {}],
      editor: "David",
      modifiedAt: new Date(),
      fills: 0
    });
    
  }
  // This code only runs on the server
  // Only publish tasks that are public or belong to the current user
  Meteor.publish("pieces", function piecePublication() {
    // check(pageId, Number);
    return Pieces.find(
      {},
      {
        fields: {
          name: 1,
          owner: 1,
          createdAt: 1,
          private: 1,
          size: 1,
          board: 1,
          colors: 1,
          cells: 1,
          editor: 1,
          modifiedAt: 1,
          fills: 1
        },
        sort: { fills: -1 },
        limit: 3
      }
    );
  });
}

Meteor.methods({
  "piece.fill"(id, r, c, color) {
    check(id, String);
    check(r, Number);
    check(c, Number);
    check(color, String);
    color = color.toUpperCase();
    const res = Pieces.findOne({_id: id});
    if (res) {
      const area = res.board[r][c];
      const oldColor = res.colors[area];
      const oldEditor = res.editors[area];
      const oldModify = res.modifiedAt[area];
      console.log(res, color, oldColor);
      if (!(color === oldColor)) {
        const colorString = "colors." + area;
        const cellString = "cells." + area;
        const editorString = "editors." + area;
        const modifyString = "modifiedAt." + area;
        Pieces.update(
          {},
          {
            $set: {
              [colorString]: color,
              [cellString]: { r, c },
              [editorString]: this.userId ? Meteor.user().username : oldEditor,
              [modifyString]: this.userId ? new Date() : oldModify
            }
          }
        );
      }
    }
  }
});
